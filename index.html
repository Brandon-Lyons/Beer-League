<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="css/bootstrap-responsive.css">
	<link rel="stylesheet" type="text/css" href="css/stylesheet.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script src="jquery-1.9.1.min.js"></script>
	<script src="bootstrap.js"></script>
	<script src="jquery.validate.js"></script>
	<script src="jquery.tablesorter.min.js"></script> 
	<script src="schedule.js"></script>
	<script>
	$(document).ready(function(){

		var league_array = [];
		var win_per = 0;
		//hide team limit alert upon load
		$('.alert').hide();

		$('#mytable').tablesorter(); 

		$.ajax({type: 'GET', url: '/backliftapp/team', success: function (data) {
			league_array.push(data); 
			printTeam(data); // populates table on load
			scheduleWrite(data);	
			sortTable(); // loads and triggers tablesorter on an empty table
			}
		});       

		var validate = $("#modal_form").validate({
			rules: {
			    teamName: {
			      minlength: 2,
			      maxlength: 32,
			      required: true
				},
			    mgr_fname: {
			      minlength: 2,
			      maxlength: 20,
			      required: true
				},
			    mgr_lname: {
			      minlength: 2,
			      maxlength:20,
			      required: true
				},
			    phone: {
			      digits: true,
			      required: true,
			      rangelength: [10, 10]
				},
			    sponsor: {
			      minlength: 2,
			      maxlength: 20,
			      required: true
				},
			    zip: {			 
			      digits: true,
			      required: true,
			      rangelength: [3, 3]
				}
			},
			highlight: function(element) {
			    $(element).closest('.control-group').removeClass('success').addClass('error');
			},
			success: function(element) {
			    element
			    .text('OK!').addClass('valid')
			    .closest('.control-group').removeClass('error').addClass('success');
			}
		});

		$('#create_team').on('show', function (e) { // max team limit function
    		if (league_array[0].length === 8) {
    			$('.alert').show();
    			return e.preventDefault();
    		};  	
		}); //end team limit func

		$('#createTeam').click(function () {						
					
			var team = {
				id: league_array.length + 1,
	 			teamName: $('#teamName').val(),
			    firstName: $('#mgr_fname').val(),
			    lastName: $('#mgr_lname').val(),
			    phoneNumber: $('#phoneNumber').val(),
			    sponsor: $('#sponsor').val(),
			    zip: "37" + $('#zip').val(),
			    wins: 0,
			    losses: 0  	  
			};

			lineWrite(); //adds single row on form submit
			// validForm(); //form validation - requires fields *NOT WORKING*

    		$.ajax({
    			url: "/backliftapp/team",
				type: "POST",
				dataType: "json",
				data: team,
				success: function () {
					league_array.push(team);
				}				 
			});
			$('#create_team').modal('hide'); //hide modal on submit...
			clearForm(); //clear form inputs	
			validateClear(); //clears validate status on form submit
			sortTable(); //loads sort table on empty table  
 				    
		}); //end submit click function	

		$('table').on('click', '.nix', function () {
			$.ajax({
    			url: "backliftapp/team/" + $(this).attr('data-id'),
				type: "DELETE",
				dataType: "json",
				success: function () {
					league_array[0].splice($(this).attr('data-index'), 1);
				}
				 
			});
			$(this).closest('tr').remove();

		}); //end delete entry

		function calcPer(data, index){
				//variables used in calculating & displaying win %
				var raw_per, per_array;
	    		raw_per = 0;
	    		per_array = 0;
	    		//calculates win percentage to 3 decimal places
	    		raw_per = (data[index].wins/(data[index].wins + data[index].losses)).toFixed(3); 
	    		if (raw_per < 1) { //if number is less than 1, omit the pre-decimal 0 when displayed.
	    			per_array = raw_per.split('.');
	    			win_per = '.' + per_array[1];
	    		}
	    		else if (isNaN(raw_per)) { //if raw_per isn't a number, write .000
	    			win_per = ".000";
	    		}
	    		else { //if number is 1, display full number.
	    			win_per = "1.000";
	    		};  		
		}; // end calcPer func

		function printTeam(data){ 		//populates table on load. Contains popover content. 
			for (var index = 0; index < data.length; index++) { 
				calcPer(data, index);

				$('<tr><td><a rel="popover" data-toggle="popover" title="<h4 style=\'text-align: center;\'>' + data[index].teamName + '</h4>"  data-content="<table id=\'contact_pop\'><tr><td>Manager: </td><td>' + data[index].firstName + " " + data[index].lastName + '</td></tr><tr><td>Phone:</td><td>' + data[index].phoneNumber + '</td></tr><tr><td>Sponsor:</td><td>' + data[index].sponsor + '</td></tr><tr><td>Zip:</td><td>' + data[index].zip +'</td></tr></table>">' + data[index].teamName + '</a><button type="button" class="close nix" style="margin-right: 10px;" data-id="' + data[index].id + '" data-index="' + index + '">&times;</button></td><td>' + data[index].wins + '</td><td>' + data[index].losses + '</td><td>' + win_per + '</td></tr>').appendTo('#standings');
					};
		}; //end printTeam func

		function lineWrite(team) {
			var index = league_array.length;
			$('<tr><td><a rel="popover" data-toggle="popover" title="<h4 style=\'text-align: center;\'>' + $('#teamName').val() + '</h4>"  data-content="<table id=\'contact_pop\'><tr><td>Manager:</td><td>' + $('#mgr_fname').val() + " " + $('#mgr_lname').val() + '</td></tr><tr><td>Phone:</td><td>' + $('#phoneNumber').val() + '</td></tr><tr><td>Sponsor:</td><td>' + $('#sponsor').val() + '</td></tr><tr><td>Zip:</td><td> 37' + $('#zip').val() +'</td></tr></table>">' + $('#teamName').val() + '</a><button type="button" class="close nix" style="margin-right: 10px;" data-id="' + (index + 1) + '" data-index="' + index + '">&times;</button></td><td>0</td><td>0</td><td>.000</td></tr>').appendTo('#standings');

		}; //end lineWrite func

		function clearForm(){
			$('.team_inputs').each(function(){
				$(this).val('');
			});
		}; //end clearForm func

		//resets form validation on opening. 
		function validateClear() {
			$('.control-group').removeClass('success error');
			validate.resetForm();
		}; //end validateClear func

		//sorts table on new submit
		function sortTable() { 
			// let the plugin know that we made a update 
	        $("#mytable").trigger("update"); 
	        //set sorting column and direction, this will sort on the first and third column 
	        var sorting = [0,0]; 
	        //sort on the first column 
	        $("#mytable").trigger("sorton", [sorting]); 
	        return false;	        
		}; //end sortTable

		function scheduleWrite(data) {
			var sched;

			if (data.length === 4) {
				sched = sched4;
			}
			else if (data.length === 5 || data.length === 6) {
				sched = sched6;
			}
			else {
				sched = sched8;
			}; // end set sched variable

			if (data.length % 2 !== 0) {
				writeSchedOdd(data, sched);
			}
			else {
				writeSchedEven(data, sched);
			}; // end even/odd selector
		}; //end scheduleWrite func

		function writeSchedEven(data, sched) {
			for (var i = 0; i < sched.length; i++) { //weeks loop
				$('<tr><th colspan="2">Week ' + (i + 1) + ' Matchups</th></tr>').appendTo('#schedule_body');
				for (var j = 0; j < sched[i].length; j++) { //games loop
					$('<tr><td colspan="2">' + data[sched[i][j][0] - 1].teamName + " vs. " + data[sched[i][j][1] - 1].teamName + "</td></tr>").appendTo('#schedule_body');
					$('<tr><td>' + data[sched[i][j][0] - 1].teamName + '</td><td>score</td></tr>').appendTo('#schedule_body');
					$('<tr><td>' + data[sched[i][j][1] - 1].teamName + '</td><td>score</td></tr>').appendTo('#schedule_body');
				};
			};
		}; //end writeSchedEven func

		function writeSchedOdd(data, sched) {
			for (var i = 0; i < sched.length; i++) {
				$('<tr><th colspan="2">Week ' + (i + 1) + ' Matchups<br><span style="font-weight:200; font-size: 0.9em;">(' + data[sched[i][0][1] - 2].teamName + ' have a bye this week.)</span></th></tr>').appendTo('#schedule_body');
				for (var j = 1; j < sched[i].length; j++) {
					$('<tr><td colspan="2">' + data[sched[i][j][0] - 2].teamName + " vs. " + data[sched[i][j][1] - 2].
						teamName + "</td></tr>").appendTo('#schedule_body');
					$('<tr><td>' + data[sched[i][j][0] - 2].teamName + '</td><td>score</td></tr>').appendTo('#schedule_body');
					$('<tr><td>' + data[sched[i][j][1] - 2].teamName + '</td><td>score</td></tr>').appendTo('#schedule_body');
				};
			};		
		}; //end writeSchedOdd

	}); //end doc ready

	</script>

</head>
<body>
	<div class="container">
		<div class="row-fluid" style="text-align: center;">
			<h1>Beer League Standings</h1>
		</div>
		<div class="row-fluid">
			<table id="mytable" class="tablesorter span10 offset1" cellspacing="1">
				<thead>
					<tr><th>Team</th><th>Wins</th><th>Losses</th><th>Win %</th></tr>
				</thead>
				<tbody id="standings">
				</tbody>
			</table>
		</div> <!-- end table row -->
		<div class="row-fluid top_bump">
			<a href="#create_team" type="button" id="create_team_button" role="button" class="btn offset1" data-target="#create_team"  data-toggle="modal">Create New Team</a>	
		</div> <!-- end button row -->
		<div class="row-fluid">
			<table class="span6 offset1" style="margin-top: 20px;">
				<tbody id="schedule_body">
				</tbody>
			</table>
		</div>
		<div id="create_team" class="modal hide fade">
			<div class="modal-header">
			    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			    <h3>Contact Form</h3>
			</div>
			<div class="modal-body">
				<form id="modal_form" class="form-horizontal" style="margin-top: 20px;">
				  <div class="control-group">
				    <label class="control-label" for="teamName">Team Name</label>
				    <div class="controls">
				      <input type="text" class="team_inputs" id="teamName" name="teamName" placeholder="Mojo's Maraudin' Morons">
				    </div>
				  </div>
				  <div class="control-group">
				    <label class="control-label" for="mgr_fname">Manager's First Name</label>
				    <div class="controls">
				      <input type="text" class="team_inputs" id="mgr_fname" name="mgr_fname" placeholder="Mojo" >
				    </div>
				  </div>
				  <div class="control-group">
				    <label class="control-label" for="mgr_lname">Manager's Last Name</label>
				    <div class="controls">
				      <input type="text" class="team_inputs" id="mgr_lname" name="mgr_lname" placeholder="Nixon">
				    </div>
				  </div>
				  <div class="control-group">
				    <label class="control-label" for="phone">Phone Number</label>
				    <div class="controls">
				      <input type="text" id="phoneNumber" class="team_inputs" name="phone" placeholder="1234567890">
				    </div>
				  </div>
				  <div class="control-group">
				    <label class="control-label" for="sponsor">Team Sponsor</label>
				    <div class="controls">
				      <input type="text" class="team_inputs" id="sponsor" name="sponsor" placeholder="Mojo's Lobotomy Supplies">
				    </div>
				  </div>
				  <div class="control-group input-prepend">
				    <label class="control-label" for="zip">Zip Code</label>
				    <div class="controls">
				      <span class="add-on">37</span>
				      <input type="text" class="team_inputs" id="zip" name="zip" placeholder="216">
				    </div>
				  </div>
				  <div class="control-group">
				    <div class="controls">
				      <button id="createTeam" class="submit" onclick="return false">Submit</button>
				    </div>
				  </div>
				</form>
			</div>
		</div> <!-- end modal -->		
		<div class="alert" style="margin-top: 20px;">
		  <button type="button" class="close" data-dismiss="alert">&times;</button>
		  <strong>Sorry!</strong> This league is full.
		</div>
	</div>
<script type="text/javascript">

	$('body').popover({
 		selector: '[rel=popover]',
  		html:  true,
  	    trigger: 'hover',
  	    placement: 'bottom'
  	});

</script>

</body>
</html>